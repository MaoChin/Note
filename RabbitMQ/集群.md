# 集群

横向扩展，通过添加更多的节点（`RabbitMQ`服务器）来线性地扩展消息通信的吞吐量，当一个`RabbitMQ`节点宕机时，客户端能够重新连接到集群中的任何其他节点并继续生产或者消费。  

### 1. 仲裁队列（`Quorum Queues`）

`RabbitMQ`的仲裁队列是一种基于`Raft`一致性算法实现的持久化、可复制的`FIFO`队列，仲裁队列提供队列复制的能力，保障数据的高可用性和安全性，使用仲裁队列可以在`RabbitMQ`集群节点间进行队列数据的复制，从而达到在一个节点宕机时，队列仍然可以提供服务的效果。  

#### `Raft`算法

一种共识算法。常见的共识算法有：`Paxos, Raft, Zab`等：

1. `Paxos`：一种经典的共识算法，用于解决分布式系统中的一致性问题。
2. `Raft`：一种较新的共识算法，`Paxos`不易实现，`Raft`是对`Paxos`算法的简化和改进，旨在易于理解和实现。  
3. `Zab`：`ZooKeeper`使用的共识算法，基于`Paxos`算法，大部分和`Raft`相同。  

一些`Raft`算法的概念：

1. 主节点（`Leader`）
2. 从节点（`Follower`）
3. 候选人（`Candidate`）
4. 选举主节点的操作，选主（`Leader election`）
5. 任期（`Trem`），一个自增的值，标识当前任期
6. 主从复制/日志复制（`Log replication`）
7. 请求投票（`Request VoteRPCs`），由`candidate`在选举过程中发出
8. `Append EntriesRPCs`：由`leader`发出，用来做日志复制和提供心跳机制  

#### 消息复制

主节点负责和生产者消费者通信，然后把更改同步到从节点：

![image-20241213121114285](E:\Note\RabbitMQ\集群.assets\image-20241213121114285.png)

消息复制和选举的操作,需要超过半数的节点同意。比如：当生产者发送一条消息，需要超过半数的节点都将消息写入磁盘以后才主节点会向生产者进行确认。  

### 2. `HAProxy`负载均衡

有了集群（`Quorum Queue`）后生产者和消费者都连接到主节点，会导致主节点压力很大，而且主节点宕机后虽然底层可以选举出新的主节点，但是在代码层面连接的服务器是写死的！！这时就会有问题，为了解决上述问题，就可以使用负载均衡策略。

`HAProxy(High Availability Proxy)`是一个开源的负载均衡器和`TCP/HTTP`应用程序的代理服务器，它被设计用来提供高可用性，负载均衡和代理功能。`HAProxy`主要用于分发网络流量到多个后端服务器，以提高网络的可靠性和性能。  

（引入负载均衡后这个负载均衡服务器也会面临==单点问题==！通常情况下，会使用`Keepalived`等高可用解决方案对`HAProxy`做主备）

使用`HAProxy`后，在代码层面只需要连接负载均衡服务器就可以了！

 









