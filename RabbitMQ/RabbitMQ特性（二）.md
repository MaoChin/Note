# `RabbitMQ`特性（二）

==本小节的特性不只是`RabbitMQ`的，而是针对所有消息队列的。==

### 1. 幂等性保证

在消息队列中，幂等性是指同一条消息被多次消费对系统的影响是一样的，即不会因为多次消费而导致一些问题。

一般消息中间件的消息传输保障分为三个层级：

1. `At most once`：最多一次，消息可能会丢失，但绝不会重复传输（没有可靠性保证）
2. `At least once`：最少一次，消息不会丢失，但可能会重复传输（一系列可靠性机制）
3. `Exactly once`：恰好一次，每条消息只传输一次且一定会传输一次。（这个非常难达到！）  

一般消息队列使用一系列可靠性机制达到`At least once`层级，这时消费者就有可能对同一条消息处理多次！！如果没有幂等性保证，就有可能有严重后果，比如重复扣款。

==幂等性保证的一些方法：==

1. ==在全局==为每条消息分配一个唯一标识符，比如`UUID`或者`MQ`消息中的唯一`ID`（注意`deliveryID`不是全局唯一的，仅仅实在`channel`内唯一），当消费者处理时先查询是否处理过这条消息，然后再处理并进行记录（比如保存到`redis`里）。
2. 业务逻辑判断：比如通过检查数据库中是否已存在相关数据记录，或者使用乐观锁机制来避免更新已被其他事务更改的数据等方式，确保消息对应的操作尚未执行。

### 2. 顺序性保证

消息的顺序性是指消费者消费的消息和生产者发送消息的顺序是一致的。其实大多数时候是不需要顺序性保证的，但是也有一部分情况需要进行顺序性保证。（`RabbitMQ`是不保证顺序的）

一些顺序性保证的策略：

1. 单队列单消费者（效率低）  
2. 分区消费（一个分区内由一个消费者进行消费）
3. 消息确认机制  
4. 业务逻辑控制  

### 3. 消息积压问题

消息积压是指在`broker`中，待处理的消息数量超过了消费者处理能力，导致消息在队列中不断堆积的现象。

消息积压产生的原因：

1. 消息生产过快  
2. 消费者处理能力不足
3. 网络延迟
4. `RabbitMQ`服务器配置偏低  

消息积压问题的一些解决方案：

1. 提高消费者效率  
2. 限制生产者速率 
3. 资源与配置优化   