# `Redis `哨兵(`sentinel`)

引入哨兵节点(==一个独立的进程==)，**监控主从节点以及其他哨兵节点**。解决主从复制模型中主节点宕机后无法自动恢复问题，即高可用问题。

一般哨兵节点也会有多个，==一是防止 哨兵节点 的单点问题==，就是当这个哨兵节点挂了，那主节点挂了就无法自动恢复了；==二是防止 一个哨兵节点 出现误判==，本来主节点没挂，但是一个哨兵节点误判其挂了(实际中是多个哨兵节点协商判断)。

**提供服务的还是主从节点，哨兵节点只是进行监控和恢复。**

## 1. 哨兵模式架构

![image-20231004095707288](E:\Note\Redis\Redis哨兵.assets\image-20231004095707288.png)

监控：哨兵进程和`redis`节点之间建立`TCP`长连接，并定期的发送心跳包。

哨兵节点的工作：

1. 监控，监控主从节点以及其他哨兵节点。
2. 主节点故障转移，发现主节点发生故障后选出一个从节点当新的主节点，并将其他从节点的主节点设置成这个新的主节点。
3. 通知，就是通知应用方新的主节点信息。
4. 配置提供者，在哨兵模式中客户端连接的是哨兵节点，从而获取主节点信息，而不是直接连接主节点。

## 2. 手动配置哨兵模式(基于`docker`)

**在实际中每一个节点(包括主从节点和哨兵节点)都是在不同的服务器上的**，这样才能发挥他们分布式的功能！！！

但是这里只是为了学习，就全部放在一台服务器上了！！这样无论是高可用还是高性能都是没有任何用的！！因为只有一台机器，而且这个服务器宕机了全部凉凉。

而且这样放在一台主机上还有一个问题：各个节点之间的端口，配置文件，数据文件会发生冲突！！要把他们分开处理。要是每个节点放在不同的服务器上，就不会有这些冲突了。

==在本机使用`docker`就可以解决上述问题！！==

### 1. `docker`介绍与安装

用`docker`这样的虚拟化技术，构建出多个相互隔离的虚拟化环境。

#### `docker`配置文件

`docker`使用 `yml`文件作为配置文件。

几种经典配置文件格式：

1. `xml`

```xml
<student>
  <id>1</id>
  <name>zhangsan</name>
  <age>19</age>
</student>
```

和`html`很像，通过标签实现配置。但是`html`中的标签是观官方规定的，但是`xml`中的标签是自定义的，自己想写啥写啥。

缺点：标签写起来很麻烦，而且占用空间大。**现在很少用了。**

2. `json`

   ```json
   {
     id: 1,
     name: 'zhangsan',
     age: 19
   }
   ```

   基于键值对，使用 { } 表示层级结构。**现在主流使用。**

3. `yml`

```yml
student:
	id: 1
	name: "zhangsan"
	age: 19
```

也是基于键值对，和`json`有点像，使用缩减表示层级结构。**用的也很多。**

对格式要求更严格，可读性更好一点。

 ### 2. 主从节点的配置启动

略。

### 3. 哨兵节点的配置启动

略。

## 3. 哨兵重新选举主节点流程(面试题)

哨兵节点通过定期发送心跳包的方式监控数据节点。

==主观下线(`subjective down`)：==某一个哨兵节点判断主节点宕机了。因为也有可能是这个哨兵节点自己网络有问题而导致的，所以称为主观下线。

==客观下线(`objective down`)：==主观下线后所有哨兵节点会进行投票，当主节点宕机的票数 大于等于 法定票数(在配置文件中设置的)，就判断为客观下线，即主节点确实宕机了。

判断为客观下线后的选举过程：

1. 所有的哨兵节点先选出一个**`leader`哨兵节点**，这个选举就是“先下手为强”，谁先抢到就是谁。
2. ==`leader`哨兵节点代表所有的哨兵节点选一个新的主节点即后续操作。==

`leader`哨兵节点选新的主节点：

1. **先看这些从节点的优先级**，这个优先级在配置文件中，可以设置。优先级高的上位。
2. 若大家优先级一样，**再看这些从节点 同步数据的 `offset` **，就是哪一个从节点从  主节点哪里复制的数据多，多的上位。
3. 若还是一样，那这个`leader`哨兵节点就选`runid`最小的那个从节点的上位。



确定好了新的主节点后， `leader`节点就会让该节点执行 `slave no one`成为 `master`节点；然后让其他所有的从节点 执行 `slaveof 新主节点ip 新主节点port` 依附于这个新的主节点。

