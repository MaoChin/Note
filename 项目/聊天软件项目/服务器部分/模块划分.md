# 模块划分

## 1. 语言识别与转换模块

比较简单的一个模块，不涉及和其他模块的交互，只需使用第三方的`API`进行语音进行识别转换即可。

使用到的子模块：

1. `gflags`参数解析
2. `sqdlog`日志打印
3. `etcd`进行服务注册与发现
4. `brpc`搭建`rpc`服务器
5. 语音识别`SDK`

## 2. 文件上传下载模块

也是相对简单的一个模块，不涉及到和其他模块的交互，主要有以下四个功能：

1. 单个文件的上传
2. 单个文件的下载
3. 多个文件的上传
4. 多个文件的下载

使用到的子模块：

1. `gflags`参数解析
2. `sqdlog`日志打印
3. `etcd`进行服务注册与发现
4. `brpc`搭建`rpc`服务器
5. 文件操作模块，使用标准库进行文件的读写操作

## 3. 用户管理模块

相对复杂的一点的模块，涉及到部分与其他模块的交互，比如聊天会话模块，文件上传下载模块等。主要有以下功能：

1. 用户名登录注册
2. 手机号登录注册
3. 短信验证码获取
4. 用户信息获取
5. 用户信息修改，包括用户名，头像，个性签名，手机号等

使用到的子模块：

1. `gflags`参数解析
2. `sqdlog`日志打印
3. `etcd`进行服务注册与发现---文件上传下载模块
4. `brpc`搭建`rpc`服务器
5. 短信验证码`SDK`
6. `odb-mysql`进行数据库封装---用户信息
7. `redis`缓存模块，缓存短信验证码，用户的登录会话信息等
8. `elasticsearch`建立倒排搜索，方便进行用户检索

## 4. 消息转发模块

当网关模块收到消息时，需要消息转发模块进行处理：

1. 根据聊天会话ID确定该消息发送的目标（单聊/群聊）
2. 调用用户管理模块确定这条消息发送者的信息以及发送时间等信息
3. 将消息发布到`RabbitMQ`消息队列中，后续由消息存储模块进行持久化存储。这样当接收消息的用户当前不在线，后续上线后可以进行消息推送

使用到的子模块：

1. `gflags`参数解析
2. `sqdlog`日志打印
3. `etcd`进行服务注册与发现---用户管理模块
4. `brpc`搭建`rpc`服务器
5. `odb-mysql`进行数据库封装---聊天会话信息
6. `RabbitMQ`进行消息的发布，后续由消息存储模块订阅，进行持久化存储

## 5. 消息存储模块

从`RabbitMQ`中订阅消息，并将获取的消息进行持久化存储以及`ES`存储，方便后续查询获取。主要功能：

1. 从`RabbitMQ`中获取消息信息，并对所有信息的属性数据存储到数据库中
2. 对于文本消息还要存储到`ES`中，方便后续查询
3. 对于语音，文件，图片等数据调用文件上传下载模块进行持久化存储
4. 提供消息获取的各种接口：获取最近的x条历史消息，根据关键字/时间查询消息

使用到的子模块：

1. `gflags`参数解析
2. `sqdlog`日志打印
3. `etcd`进行服务注册与发现---文件上传下载管理模块，用户管理模块
4. `brpc`搭建`rpc`服务器
5. `odb-mysql`进行数据库封装---消息属性信息
6. `RabbitMQ`进行消息的订阅，获取消息数据
7. `elasticsearch`建立倒排搜索，方便进行用户检索

## 6. 好友管理模块

主要进行好友和聊天会话的管理，主要功能：

1. 获取好友列表
2. 搜索用户（ES）
3. 主动申请好友
4. 当用户上线时进行好友申请的推送
5. 处理好友申请
6. 删除好友
7. 创建聊天会话（单聊/群聊）
8. 获取聊天会话（单聊/群聊）
9. 获取聊天会话成员

使用到的子模块：

1. `gflags`参数解析
2. `sqdlog`日志打印
3. `etcd`进行服务注册与发现---消息存储模块，用户管理模块
4. `brpc`搭建`rpc`服务器
5. `odb-mysql`进行数据库封装---用户关系，会话信息，好友申请事件
6. `elasticsearch`建立倒排搜索，方便进行用户检索

## 7. 网关模块

网关模块的功能如下：

1. 直接与客户端进行交互，为客户端提供服务。（内部是将请求转发到各个子服务）
2. 对客户端进行身份识别（`sessionId`），以及鉴权操作。
3. 当客户端登录时向其推送新消息，好友申请，好友删除等信息。

使用到的子模块：

1. `gflags`参数解析
2. `sqdlog`日志打印
3. `etcd`进行服务注册与发现---所有以上六个模块
4. `brpc`搭建`rpc`服务器
5. `redis`缓存模块，用户的登录会话信息（鉴权）
6. 搭建`HTTP`服务器接受客户端请求（`cpp-httplib`）
7. 搭建`Websocket`服务器向客户端推送信息（`websocketpp`）
8. 客户端长连接管理：客户端登录成功后需要与服务器建立长连接





